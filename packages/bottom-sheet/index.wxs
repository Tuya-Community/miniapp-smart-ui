function getHeight(contentHeight) {
  var height = contentHeight
    ? typeof contentHeight === 'number'
      ? contentHeight + 'rpx'
      : contentHeight
    : 'undefined';
  return 'height: ' + height + ';';
}

function queryComponent(ownerInstance, instanceId, selector) {
  var root = ownerInstance.selectComponent('#' + instanceId);
  return selector ? root.selectComponent(selector) : root;
}

function getContentNode(ownerInstance, instanceId) {
  return queryComponent(ownerInstance, instanceId, '.smart-bottom-sheet__content');
}

var state = {};

function getEndY(params) {
  var instanceId = params.instanceId;
  var endY = params.endY;
  var minHeight = params.minHeight;
  var maxHeight = params.maxHeight;
  var midHeight = params.midHeight;
  var windowHeight = params.windowHeight;

  var B = windowHeight;
  maxHeight = maxHeight || B * 0.9;
  minHeight = minHeight || B * 0.1;
  midHeight = midHeight || B * 0.5;

  var splitHeight = (maxHeight + midHeight) * 0.5;
  var splitLow = (midHeight + minHeight) * 0.5;

  if (endY > splitHeight) {
    return maxHeight;
  } else if (endY > midHeight) {
    return midHeight;
  } else if (endY > splitLow) {
    return midHeight;
  } else {
    return minHeight;
  }
}

function onDrag(instanceId) {
  return function (e, ownerInstance) {
    var delta = e.touches[0].pageY - state[instanceId].startY;
    var contentNode = getContentNode(ownerInstance, instanceId);

    var originHeight = state[instanceId].originHeight;
    state[instanceId].delta = delta;

    var newHeight = originHeight - delta;
    state[instanceId].newHeight = newHeight;

    contentNode.setStyle({
      height: newHeight + 'px',
    });
  };
}

function onDragStart(instanceId) {
  return function (e, ownerInstance) {
    var contentNode = getContentNode(ownerInstance, instanceId);
    var rect = contentNode.getBoundingClientRect();
    var originHeight = rect.height;

    state[instanceId] = {
      startY: e.touches[0].pageY,
      originHeight: originHeight,
    };
  };
}

function onDragEnd(instanceId, data) {
  return function (e, ownerInstance) {
    var minDragHeight = data.minDragHeight;
    var maxDragHeight = data.maxDragHeight;
    var midDragHeight = data.midDragHeight;
    var windowHeight = data.windowHeight;
    var newHeight = state[instanceId].newHeight;

    var endHeight = getEndY({
      instanceId: instanceId,
      endY: newHeight,
      minHeight: minDragHeight,
      maxHeight: maxDragHeight,
      midHeight: midDragHeight,
      windowHeight: windowHeight,
    });
    var contentNode = getContentNode(ownerInstance, instanceId);
    contentNode.setStyle({
      height: endHeight + 'px',
      transition: 'height 0.3s ease-in-out',
    });
    setTimeout(function () {
      contentNode.setStyle({
        transition: 'none',
      });
    }, 300);
    state[instanceId] = null;
  };
}

module.exports = {
  getHeight: getHeight,
  onDrag: onDrag,
  onDragStart: onDragStart,
  onDragEnd: onDragEnd,
};
