name: Merge Check main

on: 
  pull_request:
    branches:
      - main

jobs:
  check-beta:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: 检查 Beta 版本依赖
        id: check_beta
        run: |
          echo "正在检查 package.json 中的 beta 版本依赖..."
          
          # 检查 dependencies 和 devDependencies 中是否包含 beta 版本
          BETA_DEPS=$(node -e "
            const pkg = require('./package.json');
            const deps = { ...pkg.dependencies || {}, ...pkg.devDependencies || {} };
            const betaDeps = [];
            
            for (const [name, version] of Object.entries(deps)) {
              if (version && typeof version === 'string' && version.toLowerCase().includes('beta')) {
                betaDeps.push(\`\${name}: \${version}\`);
              }
            }
            
            if (betaDeps.length > 0) {
              console.log(betaDeps.join('\\n'));
              process.exit(1);
            } else {
              console.log('未发现 beta 版本依赖');
              process.exit(0);
            }
          " 2>&1) || BETA_CHECK_FAILED=true
          
          if [ "$BETA_CHECK_FAILED" = "true" ]; then
            echo "::error::检测到 package.json 中包含 beta 版本的依赖包，不允许合并到 main 分支"
            echo ""
            echo "发现的 beta 版本依赖："
            echo "$BETA_DEPS"
            echo ""
            echo "请将以下依赖更新为稳定版本后再提交："
            echo "$BETA_DEPS"
            exit 1
          else
            echo "✅ 未发现 beta 版本依赖，检查通过"
          fi

  # test-coverage:
  #   runs-on: ubuntu-latest
    
  #   steps:
  #     - name: 检出仓库
  #       uses: actions/checkout@v4
  #       with:
  #         ref: ${{ github.event.pull_request.head.sha }}
      
  #     - name: 设置 Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '22'
  #         cache: 'yarn'
      
  #     - name: 安装依赖
  #       run: yarn install --frozen-lockfile
      
      # - name: 运行测试并生成覆盖率报告
      #   run: yarn test:cover
      #   env:
      #     TZ: Asia/Shanghai
      
      # - name: 代码覆盖率摘要
      #   uses: irongut/CodeCoverageSummary@v1.3.0
      #   with:
      #     filename: coverage/cobertura-coverage.xml
      #     badge: true
      #     fail_below_min: false
      #     format: markdown
      #     hide_branch_rate: false
      #     hide_complexity: true
      #     indicators: true
      #     output: both
      #     thresholds: '50 75'
      
      # - name: 在 PR 中添加覆盖率评论
      #   if: github.event_name == 'pull_request'
      #   uses: marocchino/sticky-pull-request-comment@v2
      #   with:
      #     recreate: true
      #     path: code-coverage-results.md
      
      # - name: 上传覆盖率到 Codecov
      #   uses: codecov/codecov-action@v4
      #   with:
          # token 对于公开仓库是可选的，不配置也能正常工作
          # 如果需要 PR 评论等高级功能，可在 GitHub Secrets 中配置 CODECOV_TOKEN
          # token: ${{ secrets.CODECOV_TOKEN }}
          # directory: ./coverage
          # flags: unittests
          # name: codecov-umbrella
          # fail_ci_if_error: false
          # verbose: true

