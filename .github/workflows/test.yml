name: Test Publish Manual

on:
  push:
    branches:
      - test/ci
  workflow_dispatch:

jobs:
  test_publish:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Get Version from package.json
      id: package_version
      run: |
        VERSION=$(node -p "require('./package.json').version")
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ Current version in package.json: ${VERSION}"

    - name: Call Publish Manual Workflow
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.PROTECT_WRITE_TOKEN }}
        script: |
          const version = '${{ steps.package_version.outputs.VERSION }}';
          const targetOwner = 'Tuya-Community';
          const targetRepo = 'ray-smart-ui';
          const targetBranch = 'test/ci';
          
          console.log(`ğŸš€ Triggering publish-manual.yml workflow with version: ${version}`);
          console.log(`ğŸ“¦ Target Repository: ${targetOwner}/${targetRepo}`);
          console.log(`ğŸ”€ Target Branch: ${targetBranch}`);
          
          if (!version || version.trim() === '') {
            throw new Error('âŒ Version is empty. Please ensure package.json contains a valid version.');
          }
          
          try {
            // å…ˆåˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„å·¥ä½œæµï¼Œæ£€æŸ¥ç›®æ ‡å·¥ä½œæµæ˜¯å¦å­˜åœ¨
            console.log('ğŸ” Checking available workflows...');
            const workflows = await github.rest.actions.listWorkflowsForRepo({
              owner: targetOwner,
              repo: targetRepo,
            });
            
            console.log(`ğŸ“‹ Found ${workflows.data.total_count} workflow(s) in the repository`);
            
            // æŸ¥æ‰¾ç›®æ ‡å·¥ä½œæµ
            const targetWorkflow = workflows.data.workflows.find(
              w => w.name === 'publish-manual.yml' || w.path === '.github/workflows/publish-manual.yml'
            );
            
            if (!targetWorkflow) {
              console.log('âš ï¸  Workflow "publish-manual.yml" not found. Available workflows:');
              workflows.data.workflows.forEach(w => {
                console.log(`   - ${w.name} (ID: ${w.id}, Path: ${w.path})`);
              });
              throw new Error(`âŒ Workflow "publish-manual.yml" not found in repository ${targetOwner}/${targetRepo}`);
            }
            
            console.log(`âœ… Found workflow: ${targetWorkflow.name} (ID: ${targetWorkflow.id})`);
            
            // ä½¿ç”¨å·¥ä½œæµ ID æˆ–æ–‡ä»¶åæ¥è§¦å‘
            const workflowId = targetWorkflow.id;
            
            await github.rest.actions.createWorkflowDispatch({
              owner: targetOwner,
              repo: targetRepo,
              workflow_id: workflowId,
              ref: targetBranch,
              inputs: {
                version: version
              }
            });
            
            console.log('âœ… Successfully triggered publish-manual.yml workflow');
            console.log(`ğŸ“‹ Please check the workflow run in the Actions tab`);
            console.log(`ğŸ”— Workflow URL: https://github.com/${targetOwner}/${targetRepo}/actions/workflows/${targetWorkflow.id}`);
          } catch (error) {
            console.error('âŒ Failed to trigger workflow:', error.message);
            if (error.response) {
              console.error(`   Status: ${error.response.status}`);
              console.error(`   Message: ${error.response.data?.message || 'Unknown error'}`);
            }
            console.error('Error details:', JSON.stringify(error, null, 2));
            throw error;
          }

