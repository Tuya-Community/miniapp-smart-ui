name: test
on: 
  pull_request:
    branches:
      - main
      - release/*
  push:
    branches:
      - main
      - release/*
jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'yarn'
      - run: echo 'å®‰è£…ä¾èµ–'
      - run: yarn install --frozen-lockfile
      - run: echo 'æ£€æŸ¥æºç ç¼–è¯‘æ˜¯å¦æ­£å¸¸'
      - run: yarn run build
      - run: echo 'æ£€æŸ¥å•å…ƒæµ‹è¯•æ˜¯å¦æ­£å¸¸'
      - run: yarn run test
      - run: echo 'ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š'
      - run: yarn run test:cover
        env:
          TZ: Asia/Shanghai
      - name: ä¸Šä¼ è¦†ç›–ç‡ JSON æ–‡ä»¶åˆ° GitHub Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-json
          path: coverage/coverage-final.json
          retention-days: 30
      
      - name: è¾“å‡º Artifact è®¿é—®ä¿¡æ¯
        run: |
          echo "## ğŸ“¦ Coverage JSON Artifact è®¿é—®æ–¹å¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ–¹å¼ä¸€ï¼šé€šè¿‡ GitHub UI ä¸‹è½½" >> $GITHUB_STEP_SUMMARY
          echo "1. è®¿é—®å·¥ä½œæµè¿è¡Œé¡µé¢: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "2. åœ¨é¡µé¢å³ä¾§æ‰¾åˆ° **Artifacts** éƒ¨åˆ†" >> $GITHUB_STEP_SUMMARY
          echo "3. ç‚¹å‡» **coverage-json** å³å¯ä¸‹è½½" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ–¹å¼äºŒï¼šé€šè¿‡ GitHub API è®¿é—®" >> $GITHUB_STEP_SUMMARY
          echo "API åœ°å€: \`https://api.github.com/repos/${{ github.repository }}/actions/artifacts\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ–¹å¼ä¸‰ï¼šç›´æ¥è®¿é—®ä»“åº“æ–‡ä»¶ï¼ˆä»… main/release åˆ†æ”¯ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "å¦‚æœå·²æ¨é€åˆ°ä»“åº“ï¼Œå¯é€šè¿‡ä»¥ä¸‹åœ°å€è®¿é—®:" >> $GITHUB_STEP_SUMMARY
          echo "- Raw URL: \`https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/.github/coverage/coverage-final.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub URL: \`https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/.github/coverage/coverage-final.json\`" >> $GITHUB_STEP_SUMMARY
      
      - name: æ›´æ–°è¦†ç›–ç‡æ•°æ®åˆ°ä»“åº“ï¼ˆä¾›å®˜ç½‘å’Œå¾½ç« ä½¿ç”¨ï¼‰
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/release/2.x')
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          mkdir -p .github/coverage
          # å¤åˆ¶å®Œæ•´çš„è¦†ç›–ç‡ JSONï¼ˆä¾›å®˜ç½‘ä½¿ç”¨ï¼‰
          cp coverage/coverage-final.json .github/coverage/coverage-final.json
          # ç”Ÿæˆè¦†ç›–ç‡æ‘˜è¦ JSONï¼ˆä¾› shields.io å¾½ç« ä½¿ç”¨ï¼‰
          node build/update-coverage-badge.js coverage/coverage-final.json .github/coverage/coverage-summary.json
          git add .github/coverage/coverage-final.json .github/coverage/coverage-summary.json
          if git diff --staged --quiet; then
            echo "è¦†ç›–ç‡æ•°æ®æœªå‘ç”Ÿå˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "chore: update test coverage data [skip ci]"
            git push origin ${{ github.ref_name }}
          fi
      