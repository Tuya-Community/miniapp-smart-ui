name: Test Publish Manual

on:
  push:
    branches:
      - test/ci
  workflow_dispatch:

jobs:
  test_publish:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PROTECT_WRITE_TOKEN }}

    - name: Get Version from package.json
      id: package_version
      run: |
        VERSION=$(node -p "require('./package.json').version")
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ Current version in package.json: ${VERSION}"

    - name: Call Publish Manual Workflow
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.PROTECT_WRITE_TOKEN }}
        script: |
          const version = '${{ steps.package_version.outputs.VERSION }}';
          const targetOwner = 'Tuya-Community';
          const targetRepo = 'ray-smart-ui';
          const targetBranch = 'test/ci';
          
          console.log(`ğŸš€ Triggering publish-manual.yml workflow with version: ${version}`);
          console.log(`ğŸ“¦ Target Repository: ${targetOwner}/${targetRepo}`);
          console.log(`ğŸ”€ Target Branch: ${targetBranch}`);
          
          if (!version || version.trim() === '') {
            throw new Error('âŒ Version is empty. Please ensure package.json contains a valid version.');
          }
          
          try {
            // å…ˆæ£€æŸ¥å·¥ä½œæµæ–‡ä»¶æ˜¯å¦å­˜åœ¨
            console.log('ğŸ” Checking if workflow file exists...');
            let workflowId = 'publish-manual.yml';
            
            try {
              // å°è¯•è·å–å·¥ä½œæµæ–‡ä»¶å†…å®¹æ¥éªŒè¯æ˜¯å¦å­˜åœ¨
              await github.rest.repos.getContent({
                owner: targetOwner,
                repo: targetRepo,
                path: '.github/workflows/publish-manual.yml',
                ref: targetBranch,
              });
              console.log('âœ… Workflow file exists in the repository');
            } catch (fileError) {
              if (fileError.status === 404) {
                console.log('âš ï¸  Workflow file not found at .github/workflows/publish-manual.yml');
                console.log(`   Checking branch: ${targetBranch}`);
                console.log(`   ğŸ’¡ Make sure the workflow file exists in the target repository and branch.`);
              } else {
                console.log(`âš ï¸  Could not verify workflow file existence (status: ${fileError.status})`);
                console.log('   Will attempt to trigger workflow anyway...');
              }
            }
            
            // å°è¯•è§¦å‘å·¥ä½œæµï¼ˆå…ˆä½¿ç”¨æ–‡ä»¶åï¼‰
            console.log(`ğŸš€ Attempting to trigger workflow: ${workflowId}`);
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: targetOwner,
                repo: targetRepo,
                workflow_id: workflowId,
                ref: targetBranch,
                inputs: {
                  version: version
                }
              });
              
              console.log('âœ… Successfully triggered publish-manual.yml workflow');
              console.log(`ğŸ“‹ Please check the workflow run in the Actions tab`);
              console.log(`ğŸ”— Workflow URL: https://github.com/${targetOwner}/${targetRepo}/actions/workflows/publish-manual.yml`);
            } catch (dispatchError) {
              // å¦‚æœä½¿ç”¨æ–‡ä»¶åå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å·¥ä½œæµ ID
              if (dispatchError.status === 404) {
                console.log('âš ï¸  Workflow not found with filename, trying to get workflow ID...');
                try {
                  // ä½¿ç”¨ GET è¯·æ±‚è·å–å·¥ä½œæµä¿¡æ¯
                  const workflowResponse = await github.request('GET /repos/{owner}/{repo}/actions/workflows/{workflow_id}', {
                    owner: targetOwner,
                    repo: targetRepo,
                    workflow_id: workflowId,
                  });
                  
                  const actualWorkflowId = workflowResponse.data.id;
                  console.log(`âœ… Found workflow ID: ${actualWorkflowId}`);
                  
                  await github.rest.actions.createWorkflowDispatch({
                    owner: targetOwner,
                    repo: targetRepo,
                    workflow_id: actualWorkflowId,
                    ref: targetBranch,
                    inputs: {
                      version: version
                    }
                  });
                  
                  console.log('âœ… Successfully triggered workflow using workflow ID');
                } catch (idError) {
                  throw dispatchError; // æŠ›å‡ºåŸå§‹é”™è¯¯
                }
              } else {
                throw dispatchError;
              }
            }
          } catch (error) {
            console.error('âŒ Failed to trigger workflow:', error.message);
            if (error.response) {
              console.error(`   Status: ${error.response.status}`);
              console.error(`   Message: ${error.response.data?.message || 'Unknown error'}`);
              if (error.response.status === 404) {
                console.error(`   ğŸ’¡ Possible reasons:`);
                console.error(`      1. Workflow file "publish-manual.yml" does not exist in ${targetOwner}/${targetRepo}`);
                console.error(`      2. Workflow file does not exist on branch "${targetBranch}"`);
                console.error(`      3. Workflow file is not in .github/workflows/ directory`);
              }
            }
            throw error;
          }

