name: Publish Beta Package

on:
  pull_request:
    branches:
      - 'release/2.x'
    types:
      - closed

jobs:
  publish_beta:
    runs-on: ubuntu-latest
    # åªåœ¨ PR è¢«åˆå¹¶æ—¶æ‰§è¡Œï¼Œé¿å…å–æ¶ˆåˆå¹¶æ—¶ä¹Ÿè§¦å‘
    if: github.event.pull_request.merged == true

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PROTECT_WRITE_TOKEN }}

    - name: Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: '22'
        cache: 'yarn'
        registry-url: 'https://registry.npmjs.org'

    - name: Configure Git Identity
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

    - name: Install Dependencies
      run: yarn install --frozen-lockfile

    - name: build
      run: yarn build

    - name: Get Package Information
      id: package_info
      run: |
        PACKAGE_NAME=$(node -p "require('./package.json').name")
        PACKAGE_BASE_VERSION=$(node -p "require('./package.json').version" | cut -d '-' -f 1)
        echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV
        echo "PACKAGE_BASE_VERSION=${PACKAGE_BASE_VERSION}" >> $GITHUB_ENV

    - name: Get Latest Beta Version
      id: latest_version
      run: |
        existing_versions=$(npm show $PACKAGE_NAME versions --json | jq -r '.[]' | grep -E "^${PACKAGE_BASE_VERSION}-beta-" || true )
        if [ -z "$existing_versions" ]; then
          echo "LATEST_VERSION=${PACKAGE_BASE_VERSION}" >> $GITHUB_ENV
        else
          latest_version=$(echo "$existing_versions" | sort -V | tail -n 1)
          echo "LATEST_VERSION=${latest_version}" >> $GITHUB_ENV
        fi
    - name: Calculate Next Beta Version
      id: next_version
      run: |
        if [ "$LATEST_VERSION" = "${PACKAGE_BASE_VERSION}" ]; then
          next_version="${PACKAGE_BASE_VERSION}-beta-0"
        else
          beta_number=$(echo "${LATEST_VERSION}" | tr '-' ' ' | awk '{print $NF}')
          next_beta=$((beta_number + 1))
          next_version="${PACKAGE_BASE_VERSION}-beta-${next_beta}"
        fi
        echo "NEXT_VERSION=${next_version}" >> $GITHUB_ENV

    - name: Update Package.json with Next Version
      run: |
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        if [ "$CURRENT_VERSION" != "${NEXT_VERSION}" ]; then
          npm version "${NEXT_VERSION}" --no-git-tag-version
        else
          echo "Package version is already ${NEXT_VERSION}, skipping version update"
        fi

    - name: Publish Package
      run: npm publish --access public --tag beta
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

    - name: Commit Changes
      run: |
        git config pull.rebase false
        git pull origin ${{ github.event.pull_request.base.ref }}
        git add .
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "chore(release): ${NEXT_VERSION} release by Github Actions"
          git log -1  # æ£€æŸ¥æœ€åçš„commitç»“æœ
        fi

    - name: Push
      # ä½¿ç”¨ä¸ªäººè®¿é—®ä»¤ç‰Œæ¥æ¨é€æ›´æ”¹ä»¥é¿å…ä¿æŠ¤åˆ†æ”¯é™åˆ¶
      run: |
        git push https://x-access-token:${{ secrets.PROTECT_WRITE_TOKEN }}@github.com/${{ github.repository }} HEAD:${{github.ref}}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Comment on PR
      uses: peter-evans/create-or-update-comment@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        issue-number: ${{ github.event.pull_request.number }}
        repository: ${{ github.event.pull_request.head.repo.full_name }}
        body: |
          The merge has been completed successfully. The current npm version is `${{ env.NEXT_VERSION }}`.

    - name: Call Publish Manual Workflow
      if: startsWith(github.event.pull_request.head.ref, 'fix/')
      id: trigger_workflow
      uses: benc-uk/workflow-dispatch@v1
      with:
        workflow: publish-manual.yml
        repo: Tuya-Community/ray-smart-ui
        token: ${{ secrets.PROTECT_WRITE_TOKEN }}
        ref: test/ci
        inputs: '{"version":"${{ env.NEXT_VERSION }}"}'

    - name: Wait for Workflow Completion
      if: startsWith(github.event.pull_request.head.ref, 'fix/')
      id: wait_workflow
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.PROTECT_WRITE_TOKEN }}
        script: |
          const targetOwner = 'Tuya-Community';
          const targetRepo = 'ray-smart-ui';
          const workflowName = 'publish-manual.yml';
          const maxWaitTime = 30 * 60 * 1000; // 30 åˆ†é’Ÿè¶…æ—¶
          const pollInterval = 10 * 1000; // æ¯ 10 ç§’æ£€æŸ¥ä¸€æ¬¡
          const startTime = Date.now();
          
          console.log('â³ Waiting for workflow to complete...');
          
          // ä½¿ç”¨å·¥ä½œæµæ–‡ä»¶åä½œä¸º IDï¼ˆGitHub API æ”¯æŒæ–‡ä»¶åæˆ–æ•°å­— IDï¼‰
          const workflowId = workflowName;
          console.log(`ğŸ“‹ Using workflow: ${workflowId}`);
          
          // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼Œè®©å·¥ä½œæµå¼€å§‹è¿è¡Œ
          await new Promise(resolve => setTimeout(resolve, 5000));
          
          // è½®è¯¢æ£€æŸ¥å·¥ä½œæµçŠ¶æ€
          let runId = null;
          let attempts = 0;
          const maxAttempts = 10;
          
          // é¦–å…ˆæ‰¾åˆ°æœ€æ–°è§¦å‘çš„å·¥ä½œæµè¿è¡Œ
          while (!runId && attempts < maxAttempts) {
            try {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: targetOwner,
                repo: targetRepo,
                workflow_id: workflowId,
                per_page: 1,
              });
              
              if (runs.data.workflow_runs.length > 0) {
                const latestRun = runs.data.workflow_runs[0];
                // æ£€æŸ¥æ˜¯å¦æ˜¯æœ€è¿‘ 2 åˆ†é’Ÿå†…è§¦å‘çš„ï¼ˆé¿å…åŒ¹é…åˆ°æ—§è¿è¡Œï¼‰
                const runTime = new Date(latestRun.created_at).getTime();
                const timeDiff = Date.now() - runTime;
                
                if (timeDiff < 2 * 60 * 1000) {
                  runId = latestRun.id;
                  console.log(`âœ… Found workflow run ID: ${runId}`);
                  console.log(`   Status: ${latestRun.status}, Conclusion: ${latestRun.conclusion || 'pending'}`);
                }
              }
            } catch (error) {
              console.log(`âš ï¸  Error finding workflow run (attempt ${attempts + 1}): ${error.message}`);
            }
            
            if (!runId) {
              attempts++;
              await new Promise(resolve => setTimeout(resolve, 3000));
            }
          }
          
          if (!runId) {
            throw new Error('Could not find the triggered workflow run');
          }
          
          // è½®è¯¢ç­‰å¾…å·¥ä½œæµå®Œæˆ
          while (true) {
            const elapsed = Date.now() - startTime;
            if (elapsed > maxWaitTime) {
              throw new Error(`Workflow did not complete within ${maxWaitTime / 1000 / 60} minutes`);
            }
            
            try {
              const run = await github.rest.actions.getWorkflowRun({
                owner: targetOwner,
                repo: targetRepo,
                run_id: runId,
              });
              
              const status = run.data.status;
              const conclusion = run.data.conclusion;
              
              console.log(`ğŸ“Š Workflow status: ${status}, Conclusion: ${conclusion || 'pending'}`);
              
              // æ£€æŸ¥æ˜¯å¦å®Œæˆ
              if (status === 'completed') {
                const runUrl = run.data.html_url;
                console.log(`âœ… Workflow completed!`);
                console.log(`ğŸ”— Run URL: ${runUrl}`);
                
                if (conclusion === 'success') {
                  console.log('âœ… Workflow completed successfully');
                  return;
                } else {
                  throw new Error(`Workflow completed with conclusion: ${conclusion}. Check ${runUrl} for details.`);
                }
              }
              
              // å¦‚æœè¿˜åœ¨è¿è¡Œï¼Œç­‰å¾…åç»§ç»­æ£€æŸ¥
              await new Promise(resolve => setTimeout(resolve, pollInterval));
            } catch (error) {
              if (error.message.includes('completed')) {
                throw error;
              }
              console.log(`âš ï¸  Error checking workflow status: ${error.message}`);
              await new Promise(resolve => setTimeout(resolve, pollInterval));
            }
          }

    - name: Comment on PR - Publish Success
      if: startsWith(github.event.pull_request.head.ref, 'fix/') && steps.wait_workflow.outcome == 'success'
      uses: peter-evans/create-or-update-comment@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        issue-number: ${{ github.event.pull_request.number }}
        repository: ${{ github.event.pull_request.head.repo.full_name }}
        body: |
          Publishing @ray-js/smart-ui has been completed successfully. The current npm version is `${{ env.NEXT_VERSION }}`.