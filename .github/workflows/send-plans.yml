name: Send PLANS to WeChat

on:
  push:
    branches:
      - 'release/*'
    paths:
      - 'PLANS.md'

jobs:
  send_plans:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Read PLANS.md and Send to WeChat Bot
      run: |
        if [ ! -f PLANS.md ]; then
          echo "PLANS.md not found"
          exit 1
        fi
        
        # 读取文件内容并使用 jq 构建 JSON，自动处理转义
        CONTENT=$(cat PLANS.md)
        JSON_PAYLOAD=$(jq -n \
          --arg content "$CONTENT" \
          '{
            msgtype: "markdown",
            markdown: {
              content: $content
            }
          }')
        
        # 使用 curl 发送到微信机器人
        curl 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=39de41a1-3fbf-4a03-96c8-23da3503318f' \
          -H 'Content-Type: application/json' \
          -d "$JSON_PAYLOAD"
